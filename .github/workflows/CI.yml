name: Lint & Test

on: [push]

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
        - uses: actions/checkout@v1
          with:
            fetch-depth: 1

        - name: Set up Python 3.7
          uses: actions/setup-python@v1
          with:
            python-version: 3.7
        
        - name: Install Poetry
          uses: dschep/install-poetry-action@v1.2

        - name: Cache Poetry virtualenv
          uses: actions/cache@v1
          id: cache
          with:
            path: ~/.virtualenvs
            key: poetry-${{ hashFiles('**/poetry.lock') }}
            restore-keys: |
              poetry-${{ hashFiles('**/poetry.lock') }}

        - name: Set Poetry config
          run: |
            poetry config settings.virtualenvs.in-project false
            poetry config settings.virtualenvs.path ~/.virtualenvs

        - name: Install Dependencies
          run: poetry install
          if: steps.cache.outputs.cache-hit != 'true'
        
        - name: Lint with flake8
          run: |
            poetry run flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
            poetry run flake8 . --count --exit-zero --max-complexity=10 --max-line-length=120 --statistics